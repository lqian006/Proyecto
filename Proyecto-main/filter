# PARA LA INTERFACE FUNCION DE SEARCH FILTER:

def Flight_Search():
    """Advanced flight search with multiple filters"""
    global bcn, aircrafts, aeroports
    
    # Check if data is loaded
    try:
        if not aircrafts or len(aircrafts) == 0:
            messagebox.showwarning("Warning", 
                                 "Please load flight data first!\n\n"
                                 "1. Column 2: Load arrivals\n"
                                 "2. Column 4: Load Departures\n"
                                 "3. Column 4: Merge Movements")
            return
    except:
        messagebox.showwarning("Warning", 
                             "Please load flight data first!")
        return
    
    # Create search window
    search_win = tk.Toplevel()
    search_win.title("ğŸ” Advanced Flight Search")
    search_win.geometry("900x700")
    search_win.configure(bg='#2c3e50')
    
    # Title
    title_label = tk.Label(search_win, text="ğŸ” ADVANCED FLIGHT SEARCH", 
                          font=('Arial', 16, 'bold'), bg='#2c3e50', fg='white')
    title_label.pack(pady=10)
    
    # Filters Frame
    filters_frame = tk.LabelFrame(search_win, text="Filters", 
                                 bg='#34495e', fg='orange', font=('Arial', 12, 'bold'))
    filters_frame.pack(padx=10, pady=10, fill=tk.X)
    
    # Row 1: Flight ID and Airline
    row1 = tk.Frame(filters_frame, bg='#34495e')
    row1.pack(fill=tk.X, padx=5, pady=5)
    
    tk.Label(row1, text="âœˆï¸ Flight ID:", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    entry_id = tk.Entry(row1, width=15, font=('Arial', 10))
    entry_id.pack(side=tk.LEFT, padx=5)
    
    tk.Label(row1, text="Airline:", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    entry_airline = tk.Entry(row1, width=15, font=('Arial', 10))
    entry_airline.pack(side=tk.LEFT, padx=5)
    
    # Row 2: Origin and Time
    row2 = tk.Frame(filters_frame, bg='#34495e')
    row2.pack(fill=tk.X, padx=5, pady=5)
    
    tk.Label(row2, text="ğŸŒ Origin:", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    entry_origin = tk.Entry(row2, width=15, font=('Arial', 10))
    entry_origin.pack(side=tk.LEFT, padx=5)
    
    tk.Label(row2, text="â° Time (HH:MM):", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    entry_time = tk.Entry(row2, width=15, font=('Arial', 10))
    entry_time.pack(side=tk.LEFT, padx=5)
    
    # Row 3: Gate and Terminal
    row3 = tk.Frame(filters_frame, bg='#34495e')
    row3.pack(fill=tk.X, padx=5, pady=5)
    
    tk.Label(row3, text="ğŸšª Gate:", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    entry_gate = tk.Entry(row3, width=15, font=('Arial', 10))
    entry_gate.pack(side=tk.LEFT, padx=5)
    
    tk.Label(row3, text="ğŸ¢ Terminal:", bg='#34495e', fg='white', font=('Arial', 10)).pack(side=tk.LEFT, padx=5)
    terminal_var = tk.StringVar(value="All")
    terminal_combo = tk.OptionMenu(row3, terminal_var, "All", "T1", "T2")
    terminal_combo.config(bg='#2c3e50', fg='white', width=10)
    terminal_combo.pack(side=tk.LEFT, padx=5)
    
    # Search button
    def perform_search():
        # Get filter values
        filter_id = entry_id.get().strip().upper()
        filter_airline = entry_airline.get().strip().upper()
        filter_origin = entry_origin.get().strip().upper()
        filter_time = entry_time.get().strip()
        filter_gate = entry_gate.get().strip().upper()
        filter_terminal = terminal_var.get()
        
        # Search through aircrafts
        results = []
        
        for aircraft in aircrafts:
            # Apply filters
            if filter_id and filter_id not in aircraft.id:
                continue
            if filter_airline and filter_airline != aircraft.AirlineCompany:
                continue
            if filter_origin and filter_origin != aircraft.OriginAirport:
                continue
            if filter_time and filter_time != aircraft.TimeLanding:
                continue
            
            # Find gate info
            gate_info = "Not Assigned"
            terminal_info = "N/A"
            area_info = "N/A"
            
            if bcn is not None:
                for terminal in bcn.terms:
                    for area in terminal.BoardingArea:
                        for gate in area.gate:
                            if gate.id == aircraft.id:
                                gate_info = gate.name
                                terminal_info = terminal.Name
                                area_info = area.name
                                break
            
            # Apply gate/terminal filters
            if filter_gate and filter_gate not in gate_info:
                continue
            if filter_terminal != "All" and filter_terminal != terminal_info:
                continue
            
            # Get origin airport info
            origin_name = aircraft.OriginAirport
            origin_country = "Unknown"
            # Try to get airport name from aeroports list
            try:
                if aeroports and len(aeroports) > 0:
                    for apt in aeroports:
                        if apt.code == aircraft.OriginAirport:
                            origin_name = apt.name if hasattr(apt, 'name') else aircraft.OriginAirport
                            # Extract country from code (first 2 letters)
                            origin_country = aircraft.OriginAirport[:2]
                            break
            except:
                # If aeroports not loaded, just use the code
                origin_country = aircraft.OriginAirport[:2] if len(aircraft.OriginAirport) >= 2 else "??"
            
            # Add to results
            results.append({
                'id': aircraft.id,
                'airline': aircraft.AirlineCompany,
                'origin': aircraft.OriginAirport,
                'origin_name': origin_name,
                'country': origin_country,
                'arrival': aircraft.TimeLanding,
                'departure': aircraft.TimeDeparture if aircraft.TimeDeparture else 'N/A',
                'gate': gate_info,
                'terminal': terminal_info,
                'area': area_info
            })
        
        # Display results
        results_text.delete('1.0', tk.END)
        
        if len(results) == 0:
            results_text.insert('end', "âŒ No flights found matching your criteria.\n\n")
            results_text.insert('end', "Try:\n")
            results_text.insert('end', "- Using fewer filters\n")
            results_text.insert('end', "- Checking your spelling\n")
            results_text.insert('end', "- Searching by airline code (e.g., VLG, RYR, IBE)\n")
        else:
            results_text.insert('end', f"âœ… Found {len(results)} flight(s)\n")
            results_text.insert('end', "="*80 + "\n\n")
            
            for i, result in enumerate(results, 1):
                results_text.insert('end', f"{'='*80}\n")
                results_text.insert('end', f"FLIGHT #{i}\n")
                results_text.insert('end', f"{'='*80}\n")
                results_text.insert('end', f"âœˆï¸  Flight ID:     {result['id']}\n")
                results_text.insert('end', f"Airline:       {result['airline']}\n")
                results_text.insert('end', f"ğŸŒ Origin:        {result['origin']} ({result['origin_name']})\n")
                results_text.insert('end', f"ğŸŒ Country:       {result['country']}\n")
                results_text.insert('end', f"â° Arrival:       {result['arrival']}\n")
                results_text.insert('end', f"ğŸ›« Departure:     {result['departure']}\n")
                results_text.insert('end', f"ğŸšª Gate:          {result['gate']}\n")
                results_text.insert('end', f"ğŸ¢ Terminal:      {result['terminal']}\n")
                results_text.insert('end', f"ğŸ“ Area:          {result['area']}\n")
                results_text.insert('end', f"\n")
        
        # Update count label
        count_label.config(text=f"ğŸ“Š Results: {len(results)} flights")
    
    btn_search = tk.Button(filters_frame, text="ğŸ” SEARCH", command=perform_search,
                          bg='#27ae60', fg='black', font=('Arial', 12, 'bold'),
                          width=15, height=2)
    btn_search.pack(pady=10)
    
    # Clear filters button
    def clear_filters():
        entry_id.delete(0, tk.END)
        entry_airline.delete(0, tk.END)
        entry_origin.delete(0, tk.END)
        entry_time.delete(0, tk.END)
        entry_gate.delete(0, tk.END)
        terminal_var.set("All")
        results_text.delete('1.0', tk.END)
        count_label.config(text="ğŸ“Š Results: 0 flights")
    
    btn_clear = tk.Button(filters_frame, text="ğŸ—‘ï¸ Clear Filters", command=clear_filters,
                         bg='#e74c3c', fg='black', font=('Arial', 11, 'bold'),
                         width=15)
    btn_clear.pack(pady=5)
    
    # Results count
    count_label = tk.Label(search_win, text="ğŸ“Š Results: 0 flights",
                          bg='#2c3e50', fg='white', font=('Arial', 11, 'bold'))
    count_label.pack(pady=5)
    
    # Results Frame
    results_frame = tk.LabelFrame(search_win, text="Search Results", 
                                 bg='#34495e', fg='orange', font=('Arial', 13, 'bold'))
    results_frame.pack(padx=10, pady=10, fill=tk.BOTH, expand=True)
    
    # Scrollbar
    scrollbar = tk.Scrollbar(results_frame)
    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    
    # Results text
    results_text = tk.Text(results_frame, wrap=tk.WORD, yscrollcommand=scrollbar.set,
                          bg='#ecf0f1', fg='#2c3e50', font=('Courier', 10),
                          padx=10, pady=10)
    results_text.pack(fill=tk.BOTH, expand=True)
    scrollbar.config(command=results_text.yview)
    
    # Initial message
    results_text.insert('end', " Enter search criteria above and click ğŸ” SEARCH\n\n")
    results_text.insert('end', "Examples:\n")
    results_text.insert('end', "- Search by airline: VLG, RYR, IBE\n")
    results_text.insert('end', "- Search by time: 14:00, 08:30\n")
    results_text.insert('end', "- Search by origin: EGCC, LMML, LGTS\n")
    results_text.insert('end', "- Search by gate: A1, B25, M5\n")
    results_text.insert('end', "- Combine filters for precise results!\n")



AL FINAL HAY QUE AÃ‘ADIR EL BOTTON:
#BUTTON SEARCH FILTER

btn_search = tk.Button(departures_frame, text='ğŸ” Flight Search', command=Flight_Search)
btn_search.pack(padx=5, pady=5, fill=tk.X)
